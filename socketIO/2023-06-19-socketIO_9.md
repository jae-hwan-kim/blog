---
title: "[DOCS] socketIO ê³µì‹ë¬¸ì„œ (11)"
categories:
    - socket
tags:
    - socketIO

last_modified_at: 2023-06-19T19:15:00
---

ì†Œì¼“ ê°ì²´(ì„œë²„ì‚¬ì´ë“œ), [The Socket instance(server-side)](https://socket.io/docs/v4/server-socket-instance/) í˜ì´ì§€ í•´ì„

# 1. The Socket instace (server-side)

ì†Œì¼“ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ìƒí˜¸ì‘ìš©í•˜ê¸° ìœ„í•œ ê¸°ë³¸ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ì´ í´ë˜ìŠ¤ëŠ” [`emit`](https://socket.io/docs/v4/server-api/#socketemiteventname-args), [`on`](https://socket.io/docs/v4/server-api/#socketoneventname-callback), [`once`](https://socket.io/docs/v4/server-api/#socketonceeventname-listener) ë˜ëŠ” [`removeListener`](https://socket.io/docs/v4/server-api/#socketremovelistenereventname-listener)ì™€ ê°™ì€ [`Node.js EventEmitter`](https://nodejs.org/api/events.html#class-eventemitter)ì˜ ëª¨ë“  ë©”ì„œë“œë¥¼ ìƒì†í•©ë‹ˆë‹¤.

<img src="https://github.com/Gaepo-transcendance-fighters/ft_transcendance/assets/85930183/9e45bc5f-f40f-4474-a63e-d602abd9b747" width="90%">

ê²Œë‹¤ê°€ ë‹¤ìŒë„ ìˆìŠµë‹ˆë‹¤.

-   [emitting](https://socket.io/docs/v4/emitting-events/#basic-emit) and [listening to](https://socket.io/docs/v4/listening-to-events/) events
-   [broadcasting events](https://socket.io/docs/v4/broadcasting-events/#to-all-connected-clients-except-the-sender)
-   [joining and leaving rooms](https://socket.io/docs/v4/rooms/#joining-and-leaving)

ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ì†ì„±ì´ ìˆìŠµë‹ˆë‹¤:

<br>

---

## 1-1. Socket#id

ìƒˆ ì—°ê²°ì—ëŠ” 20ìì˜ ì„ì˜ ì‹ë³„ìê°€ ê°ê° í• ë‹¹ë©ë‹ˆë‹¤. ì´ ì‹ë³„ìëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì˜ ê°’ê³¼ ë™ê¸°í™”ë©ë‹ˆë‹¤.

```ts
// server-side
io.on("connection", (socket) => {
    console.log(socket.id); // ojIckSD2jqNzOqIrAGzL
});

// client-side
socket.on("connect", () => {
    console.log(socket.id); // ojIckSD2jqNzOqIrAGzL
});
```

â—ï¸ ì—°ê²° ìƒíƒœ ë³µêµ¬ê°€ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°, ID ì†ì„±ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ”(ë˜ëŠ” ë””ë²„ê¹… ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”) ì„ì‹œ IDì´ë¯€ë¡œ ì£¼ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

-   IDëŠ” ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì§€ê±°ë‚˜ ì‚¬ìš©ìê°€ í˜ì´ì§€ë¥¼ ìƒˆë¡œ ê³ ì¹  ë•Œì™€ ê°™ì´ ì¬ì—°ê²°í•  ë•Œë§ˆë‹¤ ë‹¤ì‹œ ìƒì„±ë©ë‹ˆë‹¤.

-   ë‘ ê°œì˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì € íƒ­ì—ëŠ” ë‘ ê°œì˜ ë‹¤ë¥¸ IDê°€ ìˆìŠµë‹ˆë‹¤.

-   ì„œë²„ì— ì§€ì •ëœ IDì— ëŒ€í•´ ì €ì¥ëœ ë©”ì‹œì§€ íê°€ ì—†ëŠ” ê²½ìš°(ì¦‰, í´ë¼ì´ì–¸íŠ¸ì˜ ì—°ê²°ì´ ëŠì–´ì§€ë©´ ì„œë²„ì—ì„œ ì´ IDë¡œ ì „ì†¡ëœ ë©”ì‹œì§€ê°€ ì†ì‹¤ë¨)

ëŒ€ì‹  ì¼ë°˜ ì„¸ì…˜ IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”(ì¿ í‚¤ë¡œ ì „ì†¡ë˜ê±°ë‚˜ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ë˜ì–´ [auth](https://socket.io/docs/v4/client-options/#auth) í˜ì´ë¡œë“œì— ì „ì†¡ë¨).

ì°¸ê³ :

-   [ë¹„ê³µê°œ ë©”ì‹œì§€ ê°€ì´ë“œ 2ë¶€](https://socket.io/get-started/private-messaging-part-2/)
-   [ì¿ í‚¤ ì²˜ë¦¬ ë°©ë²•](https://socket.io/how-to/deal-with-cookies)

ì°¸ê³ : ì´ ì‹ë³„ìëŠ” Socket.IO ì½”ë“œë² ì´ìŠ¤ì˜ ì—¬ëŸ¬ ë¶€ë¶„ì—ì„œ ì‚¬ìš©ë˜ë¯€ë¡œ ë®ì–´ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

<br>

---

## 1-2. Socket#handshake

ì´ ê°ì²´ì—ëŠ” Socket.IO ì„¸ì…˜ì´ ì‹œì‘ë  ë•Œ ë°œìƒí•˜ëŠ” í•¸ë“œì…°ì´í¬ì— ëŒ€í•œ ëª‡ ê°€ì§€ ì„¸ë¶€ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```json
{
  headers: /* the headers of the initial request */
  query: /* the query params of the initial request */
  auth: /* the authentication payload */
  time: /* the date of creation (as string) */
  issued: /* the date of creation (unix timestamp) */
  url: /* the request URL string */
  address: /* the ip of the client */
  xdomain: /* whether the connection is cross-domain */
  secure: /* whether the connection is secure */
}
```

EX)

```json
{
    "headers": {
        "user-agent": "xxxx",
        "accept": "*/*",
        "host": "example.com",
        "connection": "close"
    },
    "query": {
        "EIO": "4",
        "transport": "polling",
        "t": "NNjNltH"
    },
    "auth": {
        "token": "123"
    },
    "time": "Sun Nov 22 2020 01:33:46 GMT+0100 (Central European Standard Time)",
    "issued": 1606005226969,
    "url": "/socket.io/?EIO=4&transport=polling&t=NNjNltH",
    "address": "::ffff:1.2.3.4",
    "xdomain": false,
    "secure": true
}
```

ğŸ’¡ `auth` ëŠ” `socket.io-client` ë¥¼ í†µí•´ `io` ìƒì„± ì‹œ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤. [ \_[`auth`](https://socket.io/docs/v4/client-options/#auth) ì°¸ê³  ]

<br>

---

## 1-3. Socket#rooms

ì†Œì¼“ì´ í˜„ì¬ ìˆëŠ” [rooms](https://socket.io/docs/v4/rooms/)ì— ëŒ€í•œ ì°¸ì¡°ì…ë‹ˆë‹¤.

```ts
io.on("connection", (socket) => {
    console.log(socket.rooms); // Set { <socket.id> }
    socket.join("room1");
    console.log(socket.rooms); // Set { <socket.id>, "room1" }
});
```

<img src="https://github.com/Gaepo-transcendance-fighters/ft_transcendance/assets/85930183/4ce74c8f-83e3-4b63-b2eb-698a7fba08e5" width="100%">

<br>

---

## 1-4. Socket#data

`fetchSockets()` ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì„ì˜ì˜ ê°ì²´ì…ë‹ˆë‹¤:

```ts
// server A
io.on("connection", (socket) => {
    socket.data.username = "alice";
});

// server B
const sockets = await io.fetchSockets();
console.log(sockets[0].data.username); // "alice"
```

ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://socket.io/docs/v4/server-instance/#utility-methods)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

<br>

---

## 1-5. Socket#conn

ê¸°ë³¸ Engine.IO ì†Œì¼“ì— ëŒ€í•œ ì°¸ì¡° ([ì—¬ê¸°](https://socket.io/docs/v4/how-it-works/)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”).

```ts
io.on("connection", (socket) => {
    console.log("initial transport", socket.conn.transport.name); // prints "polling"

    socket.conn.once("upgrade", () => {
        // called when the transport is upgraded (i.e. from HTTP long-polling to WebSocket)
        console.log("upgraded transport", socket.conn.transport.name); // prints "websocket"
    });

    socket.conn.on("packet", ({ type, data }) => {
        // called for each packet received
    });

    socket.conn.on("packetCreate", ({ type, data }) => {
        // called for each packet sent
    });

    socket.conn.on("drain", () => {
        // called when the write buffer is drained
    });

    socket.conn.on("close", (reason) => {
        // called when the underlying connection is closed
    });
});
```

<br>

---

## 1-6. ì¶”ê°€ ì†ì„±

ê¸°ì¡´ ì†ì„±ì„ ë®ì–´ì“°ì§€ ì•ŠëŠ” í•œ, ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ì— ì–´ë–¤ ì†ì„±ì´ë¼ë„ ì²¨ë¶€í•˜ì—¬ ë‚˜ì¤‘ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
// in a middleware
io.use(async (socket, next) => {
    try {
        const user = await fetchUser(socket);
        socket.user = user;
    } catch (e) {
        next(new Error("unknown user"));
    }
});

io.on("connection", (socket) => {
    console.log(socket.user);

    // in a listener
    socket.on("set username", (username) => {
        socket.username = username;
    });
});
```

<br>

---

## 1-7. Socket middlewares

ë¯¸ë“¤ì›¨ì–´ëŠ” ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚·ë§ˆë‹¤ í˜¸ì¶œëœë‹¤ëŠ” ì ì„ ì œì™¸í•˜ë©´ ì¼ë°˜ì ì¸ [ë¯¸ë“¤ì›¨ì–´](https://socket.io/docs/v4/middlewares/)ì™€ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤:

```ts
socket.use(([event, ...args], next) => {
    // do something with the packet (logging, authorization, rate limiting...)
    // do not forget to call next() at the end
    next();
});
```

`next()` ë©”ì„œë“œëŠ” ì˜¤ë¥˜ ê°ì²´ë¡œ í˜¸ì¶œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì´ë²¤íŠ¸ê°€ ë“±ë¡ëœ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì— ì „ë‹¬ë˜ì§€ ì•Šê³  ëŒ€ì‹  `error` ì´ë²¤íŠ¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.

```ts
io.on("connection", (socket) => {
    socket.use(([event, ...args], next) => {
        if (isUnauthorized(event)) {
            return next(new Error("unauthorized event"));
        }
        next();
    });

    socket.on("error", (err) => {
        if (err && err.message === "unauthorized event") {
            socket.disconnect();
        }
    });
});
```

ì°¸ê³ : ì´ ê¸°ëŠ¥ì€ ì„œë²„ ì¸¡ì—ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œëŠ” [catch-all listeners](https://socket.io/docs/v4/listening-to-events/#catch-all-listeners) ì— ê´€ì‹¬ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

---

## 1-8. Events

ì„œë²„ ì¸¡ì—ì„œ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ëŠ” ë‘ ê°€ì§€ íŠ¹ë³„í•œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.

-   [disconnect](https://socket.io/docs/v4/server-socket-instance/#disconnect)
-   [disconnecting](https://socket.io/docs/v4/server-socket-instance/#disconnecting)

<br>

### â†˜ï¸ `disconnect`

ì´ ì´ë²¤íŠ¸ëŠ” ì—°ê²°ì´ ëŠì–´ì§ˆ ë•Œ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ì— ì˜í•´ ë°œìƒí•©ë‹ˆë‹¤.

```ts
io.on("connection", (socket) => {
    socket.on("disconnect", (reason) => {
        // ...
    });
});
```

-   `server namespace disconnect`

    -   ì†Œì¼“ì´ [socket.disconnect()](https://socket.io/docs/v4/server-api/#socketdisconnectclose)ë¡œ ê°•ì œë¡œ ì—°ê²° í•´ì œ ë‹¹í–ˆìŠµë‹ˆë‹¤.

<br>

-   `client namespace disconnect`

    -   í´ë¼ì´ì–¸íŠ¸ê°€ [socket.disconnect()](https://socket.io/docs/v4/server-api/#socketdisconnectclose)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì†Œì¼“ì„ ìˆ˜ë™ìœ¼ë¡œ ì—°ê²° í•´ì œí–ˆìŠµë‹ˆë‹¤.

<br>

-   `server shutting down`

    -   ì„œë²„ê°€ ì¢…ë£Œë˜ê³  ìˆìŠµë‹ˆë‹¤.

<br>

-   `ping timeoout`

    -   í´ë¼ì´ì–¸íŠ¸ê°€ `pingTimeout` ì§€ì—° ì‹œê°„ë™ì•ˆ PONG íŒ¨í‚·ì„ ë³´ë‚´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

<br>

-   `transport close`

    -   ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤(ì˜ˆ: ì‚¬ìš©ìê°€ ì—°ê²°ì„ ëŠì—ˆê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ê°€ WiFiì—ì„œ 4Gë¡œ ë³€ê²½ë¨).

<br>

-   `parse error`

    -   ì—°ê²°ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

<br>

-   `forced close`

    -   ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ìœ íš¨í•˜ì§€ ì•Šì€ íŒ¨í‚·ì„ ìˆ˜ì‹ í–ˆìŠµë‹ˆë‹¤.

<br>

-   `forced server close`

    -   í´ë¼ì´ì–¸íŠ¸ê°€ ì œì‹œê°„ì— ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ê°€ì…í•˜ì§€ ëª»í•˜ì—¬(`connectTimeout` ì˜µì…˜ ì°¸ì¡°) ê°•ì œë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.

<br>

### â†˜ï¸ `disconnecting`

ì´ ì´ë²¤íŠ¸ëŠ” `disconnect`ì™€ ìœ ì‚¬í•˜ì§€ë§Œ [Socket#rooms](https://socket.io/docs/v4/server-socket-instance/#socketrooms) ê°€ ì•„ì§ ë¹„ì–´ ìˆì§€ ì•Šì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤.

```ts
io.on("connection", (socket) => {
    socket.on("disconnecting", (reason) => {
        for (const room of socket.rooms) {
            if (room !== socket.id) {
                socket.to(room).emit("user has left", socket.id);
            }
        }
    });
});
```

ì°¸ê³ : `connect`, `connect_error`, `newListener` ë° `removeListener` ì´ë²¤íŠ¸ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•´ì„œëŠ” ì•ˆ ë˜ëŠ” íŠ¹ìˆ˜ ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.

```ts
// BAD, will throw an error
socket.emit("disconnect");
```

<br>

---

## 1-9. ì „ì²´ API

ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ ì „ì²´ APIëŠ” [ì—¬ê¸°](https://socket.io/docs/v4/server-api/#socket)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

---

## ê¸°íƒ€

í•´ì„í•˜ë©´ì„œ ë“¤ì—ˆë˜ ìƒê°ì´ë‚˜ ì½”ë“œ ë° ì—°ìŠµ ë“±ì„ ì ìŒ

### â†˜ï¸ join ì‚¬ìš©ë²•

```ts
  handleConnection(client: any) {
    this.logger.log(`âœ… Client connected: ${client.id}`);
    // client ë¡œ ë“¤ì–´ì˜¨ socket ì— other event ë¼ëŠ” ì´ë²¤íŠ¸ ë¶€ì—¬.
    client.join('other event');
  }

  handleDisconnect(client: any) {
    this.logger.log(`âœ… Client diconnected: ${client.id}`);
  }

  @SubscribeMessage('message')
  handleEvent(@MessageBody() chat: string) {
    // other event ë¼ëŠ” ì´ë²¤íŠ¸ê°€ ìˆëŠ” ì†Œì¼“ì— message ì´ë²¤íŠ¸ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ë³´ëƒ„
    this.server.to('other event').emit('message', {
      username: 'ê¹€ì¬í™˜',
      message: chat,
    });
  }
  /*
```

---

### â†˜ï¸ ì±„íŒ…ë°© ì¸ì‹ ë°©ë²•

1. [rooms](https://socket.io/docs/v4/rooms/)

2. [data](https://socket.io/docs/v4/server-instance/#utility-methods)

<img src="https://github.com/Gaepo-transcendance-fighters/ft_transcendance/assets/85930183/a619ff7d-1d1f-4330-bac9-dd795c82d2cd" width="90%">
