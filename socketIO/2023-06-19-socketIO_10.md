---
title: "[DOCS] socketIO ê³µì‹ë¬¸ì„œ (12)"
categories:
    - socket
tags:
    - socketIO

last_modified_at: 2023-06-20T13:25:00
---

[ë¯¸ë“¤ì›¨ì–´](https://socket.io/docs/v4/middlewares/) í˜ì´ì§€ í•´ì„

# 1. Middlewares

ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ëŠ” ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ì—°ê²°ì„ ìœ„í•´ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

ë¯¸ë“¤ì›¨ì–´ ê¸°ëŠ¥ì€ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

-   ë¡œê¹…
-   ì¸ì¦/ê¶Œí•œ ë¶€ì—¬
-   ì†ë„ ì œí•œ

ì°¸ê³ : ì´ í•¨ìˆ˜ëŠ” ì—°ê²°ë‹¹ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤(ì—°ê²°ì´ ì—¬ëŸ¬ HTTP ìš”ì²­ìœ¼ë¡œ êµ¬ì„±ëœ ê²½ìš°ì—ë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤).

â˜ğŸ» Express ë¯¸ë“¤ì›¨ì–´ë¥¼ ì°¾ê³  ê³„ì‹ ë‹¤ë©´ ì´ [ì„¹ì…˜](https://socket.io/docs/v4/middlewares/#compatibility-with-express-middleware)ì„ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

## 1-1. ë¯¸ë“¤ì›¨ì–´ ë“±ë¡í•˜ê¸°

ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ëŠ” [ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤](https://socket.io/docs/v4/server-socket-instance/) ë° ë‹¤ìŒ ë“±ë¡ëœ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
io.use((socket, next) => {
    if (isValid(socket.request)) {
        next();
    } else {
        next(new Error("invalid"));
    }
});
```

ì—¬ëŸ¬ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìœ¼ë©° ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

```ts
io.use((socket, next) => {
    next();
});

io.use((socket, next) => {
    next(new Error("thou shall not pass"));
});

io.use((socket, next) => {
    // not executed, since the previous middleware has returned an error
    next();
});
```

ì–´ë–¤ ê²½ìš°ì—ë„ ë°˜ë“œì‹œ `next()`ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì§€ì •ëœ ì‹œê°„ ì´ˆê³¼ í›„ ì—°ê²°ì´ ë‹«í ë•Œê¹Œì§€ ì—°ê²°ì´ ì¤‘ë‹¨ëœ ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.

â­ï¸ ì¤‘ìš” ì°¸ê³ : ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë  ë•Œ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì‹¤ì œë¡œ ì—°ê²°ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—°ê²°ì´ ê²°êµ­ ì‹¤íŒ¨í•´ë„ `disconnect` ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ í´ë¼ì´ì–¸íŠ¸ê°€ ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°ì„ ë‹«ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.

```ts
// server-side
io.use((socket, next) => {
    setTimeout(() => {
        // next is called after the client disconnection
        next();
    }, 1000);

    socket.on("disconnect", () => {
        // not triggered
    });
});

io.on("connection", (socket) => {
    // not triggered
});

// client-side
const socket = io();
setTimeout(() => {
    socket.disconnect();
}, 500);
```

<br>

---

## 1-2. ìê²© ì¦ëª… ë³´ë‚´ê¸°

í´ë¼ì´ì–¸íŠ¸ëŠ” ì¸ì¦ ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ìê²© ì¦ëª…ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts
// plain object
const socket = io({
    auth: {
        token: "abc",
    },
});

// or with a function
const socket = io({
    auth: (cb) => {
        cb({
            token: "abc",
        });
    },
});
```

ì´ëŸ¬í•œ ìê²© ì¦ëª…ì€ ì„œë²„ ì¸¡ì˜ [í•¸ë“œì…°ì´í¬](https://socket.io/docs/v4/server-socket-instance/#sockethandshake) ê°ì²´ì—ì„œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts
io.use((socket, next) => {
    const token = socket.handshake.auth.token;
    // ...
});
```

<br>

---

## 1-3. ë¯¸ë“¤ì›¨ì–´ ì˜¤ë¥˜ ì²˜ë¦¬

`next` ë©”ì„œë“œê°€ ì˜¤ë¥˜ ê°ì²´ì™€ í•¨ê»˜ í˜¸ì¶œë˜ë©´ ì—°ê²°ì´ ê±°ë¶€ë˜ê³  í´ë¼ì´ì–¸íŠ¸ëŠ” `connect_error` ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.

```ts
// client-side
socket.on("connect_error", (err) => {
    console.log(err.message); // prints the message associated with the error
});
```

ì˜¤ë¥˜ ê°ì²´ì— ì¶”ê°€ ì„¸ë¶€ ì •ë³´ë¥¼ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts
// server-side
io.use((socket, next) => {
    const err = new Error("not authorized");
    err.data = { content: "Please retry later" }; // additional details
    next(err);
});

// client-side
socket.on("connect_error", (err) => {
    console.log(err instanceof Error); // true
    console.log(err.message); // not authorized
    console.log(err.data); // { content: "Please retry later" }
});
```

<br>

---

## 1-4. Express ë¯¸ë“¤ì›¨ì–´ì™€ì˜ í˜¸í™˜ì„±

ì¼ë°˜ì ì¸ HTTP ìš”ì²­/ì‘ë‹µ ì£¼ê¸°ì— ì–½ë§¤ì´ì§€ ì•Šê¸° ë•Œë¬¸ì—, Socket.IO ë¯¸ë“¤ì›¨ì–´ëŠ” [Express ë¯¸ë“¤ì›¨ì–´](https://expressjs.com/en/guide/using-middleware.html)ì™€ ì‹¤ì œë¡œ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì¦‰, ë²„ì „ 4.6.0ë¶€í„° Express ë¯¸ë“¤ì›¨ì–´ëŠ” ì´ì œ ê¸°ë³¸ ì—”ì§„ì—ì„œ ì§€ì›ë©ë‹ˆë‹¤:

```ts
io.engine.use((req, res, next) => {
    // do something

    next();
});
```

ë¯¸ë“¤ì›¨ì–´ëŠ” ì—…ê·¸ë ˆì´ë“œ ìš”ì²­ì„ í¬í•¨í•˜ì—¬ ë“¤ì–´ì˜¤ëŠ” ê° HTTP ìš”ì²­ì— ëŒ€í•´ í˜¸ì¶œë©ë‹ˆë‹¤.

[express-session](https://www.npmjs.com/package/express-session) ì˜ˆì‹œ)

```ts
import session from "express-session";

io.engine.use(
    session({
        secret: "keyboard cat",
        resave: false,
        saveUninitialized: true,
        cookie: { secure: true },
    }),
);
```

[helmet](https://www.npmjs.com/package/helmet) ì˜ˆì‹œ)

```ts
import helmet from "helmet";

io.engine.use(helmet());
```
