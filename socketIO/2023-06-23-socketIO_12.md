---
title: "[DOCS] socketIO ê³µì‹ë¬¸ì„œ (14)"
categories:
    - socket
tags:
    - socketIO

last_modified_at: 2023-06-23T10:52:00
---

[Using multiple nodes](https://socket.io/docs/v4/using-multiple-nodes/) í˜ì´ì§€ í•´ì„

# 1. Using multiple nodes

ì—¬ëŸ¬ ê°œì˜ Socket.IO ì„œë²„ë¥¼ ë°°í¬í•  ë•Œ ì£¼ì˜í•´ì•¼ í•  ë‘ ê°€ì§€ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤:

-   HTTP ë¡±í´ë§ì´ í™œì„±í™”ëœ ê²½ìš°(ê¸°ë³¸ê°’), ê³ ì • ì„¸ì…˜ í™œì„±í™”: [ì•„ë˜](https://socket.io/docs/v4/using-multiple-nodes/#enabling-sticky-session)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

-   í˜¸í™˜ë˜ëŠ” ì–´ëŒ‘í„°ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ [ì—¬ê¸°](https://socket.io/docs/v4/adapter/)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

<br>

---

## 1-1. Sticky load balancing

ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” ì»´í“¨í„° ê°„ì— ì—°ê²° ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ë ¤ëŠ” ê²½ìš° íŠ¹ì • ì„¸ì…˜ IDì™€ ê´€ë ¨ëœ ëª¨ë“  ìš”ì²­ì´ í•´ë‹¹ ìš”ì²­ì„ ì‹œì‘í•œ í”„ë¡œì„¸ìŠ¤ì— ë„ë‹¬í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

### â†˜ï¸ Why is sticky-session required

ì´ëŠ” HTTP ë¡±í´ë§ ì „ì†¡ì´ Socket.IO ì„¸ì…˜ì˜ ìˆ˜ëª… ë™ì•ˆ ì—¬ëŸ¬ HTTP ìš”ì²­ì„ ì „ì†¡í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì‹¤ì œë¡œ Socket.IOëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë™ê¸°í™”(ì ì„ )ë¥¼ í†µí•´ ê¸°ìˆ ì ìœ¼ë¡œ `sticky-session` ì—†ì´ë„ ì‘ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<img src="https://github.com/Gaepo-transcendance-fighters/ft_memo/assets/85930183/3f35b81b-80ef-4da4-b267-1305e0e50fcc" width="90%">

êµ¬í˜„ì€ ë¶„ëª…íˆ ê°€ëŠ¥í•˜ì§€ë§Œ, Socket.IO ì„œë²„ ê°„ì˜ ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— í° ì„±ëŠ¥ ì €í•˜ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.

â—ï¸ ë¹„ê³ 

`sticky-session` ë¥¼ í™œì„±í™”í•˜ì§€ ì•Šìœ¼ë©´ "ì„¸ì…˜ IDë¥¼ ì•Œ ìˆ˜ ì—†ìŒ"ìœ¼ë¡œ ì¸í•´ HTTP 400 ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

ì›¹ì†Œì¼“ ì „ì†¡ì€ ì „ì²´ ì„¸ì…˜ì— ëŒ€í•´ ë‹¨ì¼ TCP ì—°ê²°ì— ì˜ì¡´í•˜ê¸° ë•Œë¬¸ì— ì´ëŸ¬í•œ ì œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì¦‰, HTTP ë¡± í´ë§ ì „ì†¡ì„ ë¹„í™œì„±í™”í•˜ë©´ `sticky-session` ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:

```ts
const socket = io("https://io.yourhost.com", {
    // WARNING: in that case, there is no fallback to long-polling
    transports: ["websocket"], // or [ "websocket", "polling" ] (the order matters)
});
```

ìë£Œ: [`transports`](https://socket.io/docs/v4/client-options/#transports)

<br>

---

## 1-2. Enabling sticky-session

-   ì¿ í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ë¼ìš°íŒ… (ê¶Œì¥ ì†”ë£¨ì…˜)

-   ì‹œì‘ ì£¼ì†Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ë¼ìš°íŒ…

ì•„ë˜ì—ì„œ ì¼ë°˜ì ì¸ ë¶€í•˜ ë¶„ì‚° ì†”ë£¨ì…˜ì˜ ëª‡ ê°€ì§€ ì˜ˆë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

-   [NginX(IP-based)](https://socket.io/docs/v4/using-multiple-nodes/#nginx-configuration)
-   [Apache HTTPD (cookie-based)](https://socket.io/docs/v4/using-multiple-nodes/#apache-httpd-configuration)
-   [HAProxy (cookie-based)](https://socket.io/docs/v4/using-multiple-nodes/#haproxy-configuration)
-   [Traefik (cookie-based)](https://socket.io/docs/v4/using-multiple-nodes/#traefik)
-   [Node.js `cluster` module](https://socket.io/docs/v4/using-multiple-nodes/#using-nodejs-cluster)

ë‹¤ë¥¸ í”Œë«í¼ì˜ ê²½ìš° ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”:

-   Kubernetes: https://kubernetes.github.io/ingress-nginx/examples/affinity/cookie/

-   AWS(ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œ ë°¸ëŸ°ì„œ): https://docs.aws.amazon.com/elasticloadbalancing/latest/application/sticky-sessions.html
-   GCP: https://cloud.google.com/load-balancing/docs/backend-service#session_affinity
-   Heroku: https://devcenter.heroku.com/articles/session-affinity

â˜ğŸ» ì¤‘ìš” ì°¸ê³ : CORS ìƒí™©(í”„ë¡ íŠ¸ ë„ë©”ì¸ì´ ì„œë²„ ë„ë©”ì¸ê³¼ ë‹¤ë¥¸ ê²½ìš°)ì— ìˆê³  ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ì„ í˜¸ë„ê°€ ë‹¬ì„±ëœ ê²½ìš° ìê²© ì¦ëª…ì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.

-   Server

    ```ts
    const io = require("socket.io")(httpServer, {
        cors: {
            origin: "https://front-domain.com",
            methods: ["GET", "POST"],
            credentials: true,
        },
    });
    ```

-   Client

    ```ts
    const io = require("socket.io-client");
    const socket = io("https://server-domain.com", {
        withCredentials: true,
    });
    ```

ì¿ í‚¤ê°€ ì—†ìœ¼ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ë¥¼ ë³´ë‚´ì§€ ì•Šìœ¼ë©° HTTP 400 "ì„¸ì…˜ IDë¥¼ ì•Œ ìˆ˜ ì—†ìŒ" ì‘ë‹µì„ ë°›ê²Œ ë©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

<br>

---

## 1-3. Nginx configuration

<br>

---

## 1-4. Apache HTTPD configuration

<br>

---

## 1-5. HAProxy configuration

<br>

---

## 1-6. Traefik

<br>

---

## 1-7. Using Node.js Cluster

<br>

---

## 1-8. Passing events between nodes

ì´ì œ ì—°ê²°ì„ ìˆ˜ë½í•˜ëŠ” ì—¬ëŸ¬ Socket.IO ë…¸ë“œê°€ ìˆìœ¼ë¯€ë¡œ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸(ë˜ëŠ” íŠ¹ì • [room](https://socket.io/docs/v4/rooms/) ì˜ í´ë¼ì´ì–¸íŠ¸)ì—ê²Œ ì´ë²¤íŠ¸ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ë ¤ë©´ í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” ì»´í“¨í„° ê°„ì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•  ë°©ë²•ì´ í•„ìš”í•©ë‹ˆë‹¤.

ë©”ì‹œì§€ ë¼ìš°íŒ…ì„ ë‹´ë‹¹í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ [Adatper](https://socket.io/docs/v4/adapter/) ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.

---

## ì •ë¦¬

ì„œë²„ì˜ ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ë ¤ê³  ë©€í‹° ì„œë²„ë¥¼ êµ¬ì¶•í•œë‹¤. ì´ë•Œ ê° ì„œë²„ê°€ ê°™ì€ ë°ì´í„°ë¥¼ ê°–ê³  ìˆê¸° ìœ„í•œ ì„¤ì •ì´ í•„ìš”í•œë°, ì—¬ê¸°ì„œ ì–˜ê¸°í•˜ëŠ” ê±´ sticky-session ì´ë‹¤. sticky-session êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ IP ë˜ëŠ” ì¿ í‚¤ ë“±ì„ í™œìš©í•œë‹¤.
